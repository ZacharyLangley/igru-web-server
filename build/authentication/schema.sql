CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE TABLE IF NOT EXISTS users (
	id uuid DEFAULT uuid_generate_v4 (),
	email TEXT NOT NULL,
	full_name TEXT,
	active BOOLEAN DEFAULT TRUE,
	salt TEXT NOT NULL,
	hash TEXT NOT NULL,
	created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMP WITH TIME ZONE,
    PRIMARY KEY(id)
);
CREATE UNIQUE INDEX ON users(id);
CREATE UNIQUE INDEX ON users(email);

CREATE TABLE IF NOT EXISTS groups (
	id uuid NOT NULL DEFAULT uuid_generate_v4 (),
	name TEXT NOT NULL,
	created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMP WITH TIME ZONE,
    PRIMARY KEY(id)
);
CREATE UNIQUE INDEX ON groups(id);

CREATE TABLE IF NOT EXISTS group_members (
	user_id uuid NOT NULL,
	group_id uuid NOT NULL,
	role INTEGER NOT NULL,
	created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT CURRENT_TIMESTAMP,
	updated_at TIMESTAMP WITH TIME ZONE,
    PRIMARY KEY(user_id, group_id),
	CONSTRAINT fk_users
      FOREIGN KEY(user_id) 
	  REFERENCES users(id)
	  ON DELETE CASCADE,
	CONSTRAINT fk_groups
      FOREIGN KEY(group_id) 
	  REFERENCES groups(id)
	  ON DELETE CASCADE
);
CREATE UNIQUE INDEX ON group_members(user_id);
CREATE UNIQUE INDEX ON group_members(group_id);
CREATE TABLE IF NOT EXISTS sessions (
	id UUID NOT NULL DEFAULT gen_random_uuid(),
	user_id uuid NOT NULL,
	created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	expired_at TIMESTAMP NOT NULL,
	PRIMARY KEY(id),
	CONSTRAINT fk_session
		FOREIGN KEY(user_id) 
		REFERENCES users(id)
		ON DELETE CASCADE
);