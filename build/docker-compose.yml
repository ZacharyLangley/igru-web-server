version: "3"

services:
  broker-service:
    build:
      context: ./..
      dockerfile: build/broker-service.dockerfile
    restart: always
    ports:
      - "8080:80"
    deploy:
      mode: replicated
      replicas: 1

  init-authentication-service:
    image: cockroachdb/cockroach:v22.1.11
    command:
      - "sql"
      - "--insecure"
      - "--host"
      - "db"
      - "-e"
      - "CREATE DATABASE IF NOT EXISTS authentication;"
    depends_on:
      - db

  authentication-service:
    build:
      context: ./..
      dockerfile: build/authentication-service.dockerfile
    restart: always
    ports:
      - "8081:80"
    deploy:
      mode: replicated
      replicas: 1
    environment:
      DATABASE.PORT: "26257"
      DATABASE.USERNAME: root
      DATABASE.DATABASE: authentication
      DATABASE.HOST: db
      LOGGER.LEVEL: debug
      METRICS.JAEGERADDRESS: jaeger:14268
    depends_on:
      - init-authentication-service

  db:
    image: cockroachdb/cockroach:v22.1.11
    ports:
      - "8888:8080" # Dashboard
      - "26257:26257"
    command:
      - "start-single-node"
      - "--insecure"
    deploy:
      mode: replicated
      replicas: 1
    volumes:
      - ./db-data/cockroach/://cockroach/cockroach-data

  gardens-service:
    build:
      context: ./..
      dockerfile: build/gardens-service.dockerfile
    restart: always
    ports:
      - "8082:80"
    deploy:
      mode: replicated
      replicas: 1
    environment:
      DATABASE.PASSWORD: password
      LOGGER.LEVEL: debug
      METRICS.JAEGERADDRESS: jaeger:14268
    depends_on:
      - gardens-db
    networks:
      - gardens

  # TODO: ZL | Add auto create gardens db
  gardens-db:
    image: "postgres:14.2"
    ports:
      - "5433:5432"
    deploy:
      mode: replicated
      replicas: 1
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: gardens
    volumes:
      - ./db-data/postgres/:/var/lib/postgresql/data/
    networks:
      - gardens

  jaeger:
    image: jaegertracing/all-in-one:1.6
    ports:
      - 14268:14268 # Services
      - 16686:16686 # Frontend

networks:
  gardens:
    driver: bridge