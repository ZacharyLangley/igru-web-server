version: "3"

services:

  init-db:
    image: cockroachdb/cockroach:v22.2.8
    command:
      - "sql"
      - "--insecure"
      - "--host"
      - "db"
      - "-e"
      - "CREATE DATABASE IF NOT EXISTS authentication;"
      - "-e"
      - "CREATE DATABASE IF NOT EXISTS garden;"
      - "-e"
      - "CREATE DATABASE IF NOT EXISTS node;"
    depends_on:
      - db
    deploy:
      restart_policy:
          condition: on-failure

  authentication:
    image: igru:latest
    command: auth serve --config default.yml --level debug
    volumes:
      - ./authentication/default.yml://default.yml:ro
      - ./authentication/migrations://migrations:ro
    restart: always
    ports:
      - "8081:80"
    environment:
      DATABASE.HOST: db
      LOGGER.LEVEL: debug
      METRICS.JAEGERADDRESS: jaeger:14268
    depends_on:
      - init-db

  db:
    image: cockroachdb/cockroach:v22.2.8
    ports:
      - "8888:8080" # Dashboard
      - "26257:26257"
    command:
      - "start-single-node"
      - "--insecure"
    volumes:
      - ./db-data/cockroach/://cockroach/cockroach-data

  garden:
    image: igru:latest
    command: garden serve --config default.yml --level debug
    restart: always
    ports:
      - "8082:80"
    environment:
      DATABASE.HOST: db
      LOGGER.LEVEL: debug
      METRICS.JAEGERADDRESS: jaeger:14268
    volumes:
      - ./garden/default.yml://default.yml:ro
      - ./garden/migrations://migrations:ro
    depends_on:
      - init-db

  node:
    image: igru:latest
    command: node serve --config default.yml --level debug
    restart: always
    ports:
      - "8083:80"
    environment:
      DATABASE.HOST: db
      LOGGER.LEVEL: debug
      METRICS.JAEGERADDRESS: jaeger:14268
    volumes:
      - ./node/default.yml://default.yml:ro
      - ./node/migrations://migrations:ro
    depends_on:
      - init-db

  ingress:
    image: igru:latest
    command: ingress serve --config default.yml --level debug
    volumes:
      - ./ingress/default.yml://default.yml:ro
    ports:
      - "80:80"
    environment:
      METRICS.JAEGERADDRESS: jaeger:14268

  jaeger:
    image: jaegertracing/all-in-one:1.45.0
    ports:
      - 14268:14268 # Services
      - 16686:16686 # Frontend
